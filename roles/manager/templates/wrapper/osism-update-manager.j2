#!/usr/bin/env bash

# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN

ANSIBLE_USER=${ANSIBLE_USER:-dragon}
ANSIBLE_VERSION=${ANSIBLE_VERSION:-ansible>=2.10,<2.11}
NETADDR_VERSION=${NETADDR_VERSION:-netaddr==0.8.0}
INSTALL_ANSIBLE_ROLES=${INSTALL_ANSIBLE_ROLES:-true}
MANAGER_VERSION=${MANAGER_VERSION:-main}
PLAYBOOK=${PLAYBOOK:-playbook-manager.yml}
VENV_PATH=${VENV_PATH:-.venv}

pushd {{ configuration_directory }}/environments/manager > /dev/null

[[ -e $PLAYBOOK ]] >/dev/null 2>&1 || { echo >&2 "$PLAYBOOK is not a playbook"; exit 1; }

if [[ ! -x "$(command -v ansible-playbook)" ]]; then
    if [[ ! -e $VENV_PATH ]]; then

        if [[ ! -x "$(command -v virtualenv)" ]]; then
            sudo apt-get install -y virtualenv
        fi

        virtualenv -p python3 $VENV_PATH
        source $VENV_PATH/bin/activate
        pip3 install --no-cache-dir "$ANSIBLE_VERSION" "$NETADDR_VERSION"
    else
        source $VENV_PATH/bin/activate
    fi
fi

if [[ $INSTALL_ANSIBLE_ROLES == "true" ]]; then
    ansible-galaxy collection install -f git+https://github.com/osism/ansible-collection-services,$MANAGER_VERSION
fi

if [[ $playbook == "playbook-netbox.yml" || $playbook == "playbook-traefik.yml" ]]; then

    ansible-playbook \
        --private-key /opt/ansible/secrets/id_rsa.operator \
        -i {{ configuration_directory }}/inventory \
        -e @{{ configuration_directory }}/environments/infrastructure/images.yml \
        -e @{{ configuration_directory }}/environments/infrastructure/configuration.yml \
        -e @{{ configuration_directory }}/environments/infrastructure/secrets.yml \
        -e @{{ configuration_directory }}/environments/images.yml \
        -e @{{ configuration_directory }}/environments/configuration.yml \
        -e @{{ configuration_directory }}/environments/secrets.yml \
        -e @images.yml \
        -e @configuration.yml \
        -e @secrets.yml \
        -u $ANSIBLE_USER \
        $PLAYBOOK "$@"

else

    ansible-playbook \
        --private-key /opt/ansible/secrets/id_rsa.operator \
        -i {{ configuration_directory }}/inventory \
        -e @{{ configuration_directory }}/environments/images.yml \
        -e @{{ configuration_directory }}/environments/configuration.yml \
        -e @{{ configuration_directory }}/environments/secrets.yml \
        -e @images.yml \
        -e @configuration.yml \
        -e @secrets.yml \
        -u $ANSIBLE_USER \
        $PLAYBOOK "$@"

fi

popd > /dev/null
