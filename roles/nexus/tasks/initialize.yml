---
# NOTE: The file does not exist directly. Accordingly, the task fails at first.
- name: Get setup admin password
  community.docker.docker_container_exec:
    container: "{{ nexus_container_name }}"
    command: cat /nexus-data/admin.password
  register: result
  retries: 10
  delay: 20
  until: result.rc == 0

- name: Set admin password
  ansible.builtin.include: call-script.yml
  vars:
    nexus_admin_password: "{{ result.stdout }}"
    script_name: update-admin-password
    args:
      new_password: "{{ nexus_admin_password }}"

- name: Provision scripts
  community.docker.docker_container_exec:
    container: "{{ nexus_container_name }}"
    command: "/bin/bash -c 'NEXUS_PASSWORD={{ nexus_admin_password }} /scripts/provision.sh /scripts/{{ item }}'"
  loop: "{{ nexus_provision_scripts }}"

- name: Allow anonymous access
  community.docker.docker_container_exec:
    container: "{{ nexus_container_name }}"
    command: "/bin/bash -c 'NEXUS_PASSWORD={{ nexus_admin_password }} /scripts/enable-anonymous.sh'"

- name: Cleanup default repositories
  community.docker.docker_container_exec:
    container: "{{ nexus_container_name }}"
    command: "/bin/bash -c 'NEXUS_PASSWORD={{ nexus_admin_password }} /scripts/run.sh cleanup'"

- name: Create docker repositories
  community.docker.docker_container_exec:
    container: "{{ nexus_container_name }}"
    command: "/bin/bash -c 'NEXUS_PASSWORD={{ nexus_admin_password }} /scripts/run.sh {{ item }}'"
  loop:
    - docker-hub
    - docker-quay

- name: Create apt repositories
  community.docker.docker_container_exec:
    container: "{{ nexus_container_name }}"
    command: "/bin/bash -c 'NEXUS_PASSWORD={{ nexus_admin_password }} /scripts/run.sh {{ item }}'"
  loop:
    - ubuntu-archive
    - ubuntu-docker

# NOTE: https://github.com/savoirfairelinux/ansible-nexus3-oss
- name: Setup proxy
  ansible.builtin.include: call-script.yml
  vars:
    script_name: setup-proxy
    args:
      with_http_proxy: "{{ nexus_with_http_proxy }}"
      http_proxy_host: "{{ nexus_http_proxy_host }}"
      http_proxy_port: "{{ nexus_http_proxy_port }}"
      http_proxy_username: "{{ nexus_http_proxy_username }}"
      http_proxy_password: "{{ nexus_http_proxy_password }}"
      with_https_proxy: "{{ nexus_with_https_proxy }}"
      https_proxy_host: "{{ nexus_https_proxy_host }}"
      https_proxy_port: "{{ nexus_https_proxy_port }}"
      https_proxy_username: "{{ nexus_https_proxy_username }}"
      https_proxy_password: "{{ nexus_https_proxy_password }}"
      proxy_exclude_hosts: "{{ nexus_proxy_exclude_hosts }}"

- name: Set osism.nexus.status fact
  ansible.builtin.include_role:
    name: osism.commons.state
  vars:
    state_name: osism
    state_section: nexus
    state_option: status
    state_value: "True"
