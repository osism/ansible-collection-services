---
# NOTE: The file does not exist directly. Accordingly, the task fails at first.
- name: Get admin password
  community.docker.docker_container_exec:
    container: "{{ nexus_container_name }}"
    command: cat /nexus-data/admin.password
  register: result
  retries: 10
  delay: 20
  until: result.rc == 0

- name: Set admin password
  ansible.builtin.set_fact:
    nexus_admin_password: "{{ result.stdout }}"

- name: Provision scripts
  community.docker.docker_container_exec:
    container: "{{ nexus_container_name }}"
    command: "/bin/bash -c 'NEXUS_PASSWORD={{ nexus_admin_password }} /scripts/provision.sh /scripts/{{ item }}'"
  loop: "{{ nexus_provision_scripts }}"

- name: Allow anonymous access
  community.docker.docker_container_exec:
    container: "{{ nexus_container_name }}"
    command: "/bin/bash -c 'NEXUS_PASSWORD={{ nexus_admin_password }} /scripts/enable-anonymous.sh'"

- name: Cleanup default repositories
  community.docker.docker_container_exec:
    container: "{{ nexus_container_name }}"
    command: "/bin/bash -c 'NEXUS_PASSWORD={{ nexus_admin_password }} /scripts/run.sh cleanup'"

- name: Create docker repositories
  community.docker.docker_container_exec:
    container: "{{ nexus_container_name }}"
    command: "/bin/bash -c 'NEXUS_PASSWORD={{ nexus_admin_password }} /scripts/run.sh {{ item }}'"
  loop:
    - docker-hub
    - docker-quay

- name: Create apt repositories
  community.docker.docker_container_exec:
    container: "{{ nexus_container_name }}"
    command: "/bin/bash -c 'NEXUS_PASSWORD={{ nexus_admin_password }} /scripts/run.sh {{ item }}'"
  loop:
    - ubuntu-archive
    - ubuntu-docker

- name: Set osism.nexus.status fact
  ansible.builtin.include_role:
    name: osism.commons.state
  vars:
    state_name: osism
    state_section: nexus
    state_option: status
    state_value: "True"
