---
# tasks file for ansible_molecule
#- name: CentOS 9 specific tasks
- name: Install python3.11 and python3.11-pip
  become: true
  ansible.builtin.package:
    name:
      - python3.11
      - python3.11-pip
    state: present
  when: "'RedHat' in ansible_os_family"

- name: Install python and pip on Ubuntu 22.04
  ansible.builtin.include_role:
    name: "{{ item }}"
  loop:
    - ensure-python
    - ensure-pip
  when: "'Debian' in ansible_os_family"

- name: Install Ansible Ubuntu 22.04
  ansible.builtin.pip:
    name: "ansible=={{ ansible_molecule_ansible_version }}"
    virtualenv: "{{ ansible_molecule_venv }}"
    virtualenv_command: 'python3 -m venv'
    state: present
  when: "'Debian' in ansible_os_family"

- name: Install Ansible CentOS 9
  # Default Python version (3.9) is too old for current Ansible version
  ansible.builtin.pip:
    name: "ansible=={{ ansible_molecule_ansible_version }}"
    virtualenv: "{{ ansible_molecule_venv }}"
    virtualenv_command: 'python3.11 -m venv'
    state: present
  when: "'RedHat' in ansible_os_family"

- name: Install requirements
  ansible.builtin.pip:
    virtualenv: "{{ ansible_molecule_venv }}"
    requirements: "molecule/requirements.txt"
    chdir: "{{ zuul_work_dir }}"

- name: Run ansible-molecule
  ansible.builtin.shell:
    cmd: |
      set -e
      . "{{ ansible_molecule_venv }}"/bin/activate
      python -m molecule --debug -v test -s delegated
      python -m molecule --debug -v destroy -s delegated
    chdir: "{{ zuul_work_dir }}"
    executable: /bin/bash
  environment:
    ANSIBLE_ROLE: "{{ ansible_role }}"
  changed_when: true
