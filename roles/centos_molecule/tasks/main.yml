---
# tasks file for ansible_molecule
#- name: CentOS 9 specific tasks
- name: 'centos_molecule | CentOS 9 specific tasks'
  when: "'RedHat' in ansible_os_family"
  block:
    - name: Install python3.11 and python3.11-pip
      become: true
      ansible.builtin.package:
        name:
          - python3.11
          - python3.11-pip
        state: present

    - name: Install alternatives package
      ansible.builtin.package:
        name: alternatives
        state: present
      become: true

    - name: Register python3.11 alternative
      ansible.builtin.command:
        cmd: alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1
      become: true
      changed_when: true

    - name: Set python3.11 alternative version
      ansible.builtin.command:
        cmd: alternatives --set python3 /usr/bin/python3.11
      become: true
      changed_when: true

    - name: Register pip3.11 alternative
      ansible.builtin.command:
        cmd: alternatives --install /usr/bin/pip pip /usr/bin/pip3.11 1
      become: true
      changed_when: true

    - name: Set pip3.11 alternative version
      ansible.builtin.command:
        cmd: alternatives --set pip /usr/bin/pip3.11
      become: true
      changed_when: true

- name: Install python and pip on Ubuntu 22.04
  ansible.builtin.include_role:
    name: "{{ item }}"
  loop:
    - ensure-python
    - ensure-pip
  when: "'Debian' in ansible_os_family"

- name: Install Ansible
  ansible.builtin.pip:
    name: "ansible=={{ ansible_molecule_ansible_version }}"
    virtualenv: "{{ ansible_molecule_venv }}"
    virtualenv_command: 'python3 -m venv'
    state: present

- name: Install requirements Debian
  ansible.builtin.pip:
    virtualenv: "{{ ansible_molecule_venv }}"
    virtualenv_command: 'python3 -m venv'
    requirements: "molecule/requirements-debian.txt"
    chdir: "{{ zuul_work_dir }}"
  when: "'Debian' in ansible_os_family"

- name: Install requirements RedHat
  ansible.builtin.pip:
    virtualenv: "{{ ansible_molecule_venv }}"
    virtualenv_command: 'python3 -m venv'
    requirements: "molecule/requirements-redhat.txt"
    chdir: "{{ zuul_work_dir }}"
  when: "'RedHat' in ansible_os_family"

- name: Run ansible-molecule
  ansible.builtin.shell:
    cmd: |
      set -e
      . "{{ ansible_molecule_venv }}"/bin/activate
      python -m molecule --debug -v test -s delegated
      python -m molecule --debug -v destroy -s delegated
    chdir: "{{ zuul_work_dir }}"
    executable: /bin/bash
  environment:
    ANSIBLE_ROLE: "{{ ansible_role }}"
  changed_when: true
