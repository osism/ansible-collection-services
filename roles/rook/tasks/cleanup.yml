---
- name: Set cleanupPolicy in CephCluster resource
  kubernetes.core.k8s:
    state: patched
    kind: CephCluster
    namespace: "{{ rook_namespace }}"
    name: "{{ rook_cluster_name }}"
    definition:
      spec:
        cleanupPolicy:
          confirmation: "yes-really-destroy-data"
    kubeconfig: /share/kubeconfig

- name: "Delete CephCluster {{ rook_cluster_name }}"
  kubernetes.core.helm:
    state: absent
    release_name: "{{ rook_cluster_name }}"
    release_namespace: "{{ rook_namespace }}"

- name: Delete all CephClient resources
  kubernetes.core.k8s:
    state: absent
    kind: CephClient
    api_version: ceph.rook.io/v1
    namespace: "{{ rook_namespace }}"
    delete_all: true
    kubeconfig: /share/kubeconfig

- name: Include cleanup-labels tasks
  ansible.builtin.include_tasks: cleanup-labels.yml
  tags: cleanup-labels

- name: Include wait-for-cluster-deleted tasks
  ansible.builtin.include_tasks: wait-for-cluster-deleted.yml
  tags: wait
