---
- name: Create required directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ operator_user }}"
    group: "{{ operator_group }}"
    mode: 0750
  loop:
    - "{{ rook_work_directory }}"

- name: Find CRD templates
  ansible.builtin.find:
    path: "{{ rook_template_directory }}"
    patterns: "*-CRD-*.yml.j2"
  register: _rook_crd_templates

- name: Render CRD templates
  loop: "{{ _rook_crd_templates.files }}"
  loop_control:
    loop_var: _file
  ansible.builtin.template:
    src: "{{ _file.path }}"
    dest: "{{ rook_work_directory }}/{{ _file.path[:-3] | basename }}"
    owner: "{{ operator_user }}"
    group: "{{ operator_group }}"
    mode: 0640

- name: Deploy CRDs
  loop: "{{ _rook_crd_templates.files }}"
  loop_control:
    loop_var: _file
  kubernetes.core.k8s:
    state: present
    src: "{{ rook_work_directory }}/{{ _file.path[:-3] | basename }}"
    kubeconfig: /share/kubeconfig
